Hype is a collection of Go packages related to the Linux Kernel Virtual Machine (KVM). The long-term goal is to learn more about Linux internals, KVM, and virtio. The short-term goal is to boot a Linux guest with a virtio console on an amd64 Linux host.

[![Go reference](https://pkg.go.dev/badge/github.com/c35s/hype.svg)](https://pkg.go.dev/github.com/c35s/hype)

- Package [`kvm`](https://pkg.go.dev/github.com/c35s/hype/kvm) provides wrappers for some KVM ioctls (without cgo)
- Package [`vm`](https://pkg.go.dev/github.com/c35s/hype/kvm) provides helpers for configuring and running a VM
- Package [`linux`](https://pkg.go.dev/github.com/c35s/hype/linux) provides helpers for parsing a Linux bzImage

## An example

Nothing works yet except the easy part (basic KVM ioctls). But here's how to create a VM, run, and immediately halt:

```go
package main

import (
	"context"

	"github.com/c35s/hype/kvm"
	"github.com/c35s/hype/vm"
)

func main() {
	sys, err := kvm.Open()
	if err != nil {
		panic(err)
	}

	defer sys.Close()

	m, err := vm.New(vm.Config{
		Loader: &hltLoader{},
	})

	if err != nil {
		panic(err)
	}

	defer m.Close()

	// if err==nil, the VM halted
	if err := m.Run(context.Background()); err != nil {
		panic(err)
	}
}

// hltLoader loads a single HLT instruction at 0x0 and sets the instruction pointer to 0.
// The code segment base and sel are set to 0 as well, so the VM should halt immediately.
type hltLoader struct{}

func (l *hltLoader) LoadMemory(info vm.Info, mem []byte) error {
	mem[0] = 0xf4 // hlt
	return nil
}

func (l *hltLoader) LoadVCPU(info vm.Info, slot int, regs *kvm.Regs, sregs *kvm.Sregs) error {
	regs.RIP = 0
	sregs.CS.Base = 0
	sregs.CS.Selector = 0
	return nil
}
```

## Reference

- https://www.kernel.org/doc/Documentation/virtual/kvm/api.txt
- https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/include/uapi/linux/kvm.h
- https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/uapi/asm/kvm.h
- https://www.kernel.org/doc/Documentation/x86/boot.txt
- https://www.kernel.org/doc/Documentation/x86/zero-page.rst
- https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/uapi/asm/bootparam.h

## Development

### Building Linux

To build a guest kernel in `.build/linux/guest`, first make sure the `lib/linux` submodule is cloned by running `git submodule update --init`. It's gonna take a minute. After the submodule is cloned, run `make -j $(nproc)` to build the kernel. The build config is copied from `etc/linux/guest`. To edit the guest kernel config, run `make menuconfig-guest`.

The base x86 config was originally generated by running `make defconfig; make kvm_guest.config mod2noconfig` in `lib/linux`.

### Panics

To remove a panic, write a test that causes it, then change the code to return an annotated error, write to the log, or otherwise handle the condition instead of panicking. Simply returning the original error usually isn't useful.
